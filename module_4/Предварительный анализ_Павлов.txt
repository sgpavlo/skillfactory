/*
Задание 4.1
База данных содержит список аэропортов практически всех крупных городов России. 
В большинстве городов есть только один аэропорт. Исключение составляет:
*/

  SELECT a.city, count(a.city) city_tally
    FROM dst_project.airports a
GROUP BY a.city
ORDER BY 2 DESC
   LIMIT 2

/*
Задание 4.2
Вопрос 1. Таблица рейсов содержит всю информацию о прошлых, текущих и запланированных рейсах. 
Сколько всего статусов для рейсов определено в таблице?
*/

SELECT count(DISTINCT(f.status))
  FROM dst_project.flights f

/*
Вопрос 2. Какое количество самолетов находятся в воздухе на момент среза в базе (статус рейса «самолёт уже вылетел и находится в воздухе»).
*/

SELECT COUNT(DISTINCT(f.flight_id))
  FROM dst_project.flights f
 WHERE f.status = 'Departed'

/*
Вопрос 3. Места определяют схему салона каждой модели. Сколько мест имеет самолет модели  (Boeing 777-300)?
*/

SELECT COUNT(s.seat_no)
  FROM dst_project.seats s
 WHERE s.aircraft_code = '773'

/*
Вопрос 4. Сколько состоявшихся (фактических) рейсов было совершено между 1 апреля 2017 года и 1 сентября 2017 года?
*/

SELECT COUNT(f.flight_id)
  FROM dst_project.flights f
 WHERE f.status = 'Arrived' 
   AND f.actual_arrival between '2017-04-01' and '2017-09-01'


/*
Задание 4.3
Вопрос 1. Сколько всего рейсов было отменено по данным базы?
*/

SELECT COUNT(f.flight_id)
  FROM dst_project.flights f
 WHERE f.status = 'Cancelled'

/*
Вопрос 2. Сколько самолетов моделей типа Boeing, Sukhoi Superjet, Airbus находится в базе авиаперевозок?
*/

А)
  SELECT DISTINCT a.model, COUNT(a.model)
    FROM dst_project.aircrafts a
GROUP BY a.model
ORDER BY a.model


Б)
SELECT 'Boeing' AS fly_model, COUNT(DISTINCT a.aircraft_code)
  FROM dst_project.aircrafts a
 WHERE a.model LIKE '%Boeing%'
 UNION 
SELECT 'Sukhoi Superjet' AS fly_model, COUNT(DISTINCT a.aircraft_code)
  FROM dst_project.aircrafts a
 WHERE a.model LIKE '%Sukhoi Superjet%'
 UNION 
SELECT 'Airbus' AS fly_model, COUNT(DISTINCT a.aircraft_code)
  FROM dst_project.aircrafts a
 WHERE a.model LIKE '%Airbus%'

/*
Вопрос 3. В какой части (частях) света находится больше аэропортов?
*/

SELECT 'Europe' AS world_side, COUNT(DISTINCT a.airport_code)
  FROM dst_project.airports a
 WHERE a.timezone LIKE '%Europe%'
 UNION 
SELECT 'Australia' AS world_side, COUNT(DISTINCT a.airport_code)
  FROM dst_project.airports a
 WHERE a.timezone LIKE '%Australia%'
 UNION 
SELECT 'Asia' AS world_side, COUNT(DISTINCT a.airport_code)
  FROM dst_project.airports a
 WHERE a.timezone LIKE '%Asia%'

/*
Вопрос 4. У какого рейса была самая большая задержка прибытия за все время сбора данных? Введите id рейса (flight_id).
*/

  SELECT t.flight_id
    FROM 
         (SELECT f.flight_id, 
         f.scheduled_arrival - f.actual_arrival AS diff_time
    FROM dst_project.flights f
ORDER BY diff_time) t
   LIMIT 1

/*
Задание 4.4
Вопрос 1. Когда был запланирован самый первый вылет, сохраненный в базе данных?
*/

  SELECT f.scheduled_departure
    FROM dst_project.flights f
ORDER BY f.scheduled_departure
   LIMIT 1

/*
Вопрос 2. Сколько минут составляет запланированное время полета в самом длительном рейсе?
*/

  SELECT f.scheduled_arrival - f.scheduled_departure AS flight_time
    FROM dst_project.flights f
ORDER BY flight_time DESC
   LIMIT 1

/*
Вопрос 3. Между какими аэропортами пролегает самый длительный по времени запланированный рейс?
*/

  SELECT f.arrival_airport, f.departure_airport, f.scheduled_arrival - f.scheduled_departure AS flight_time
    FROM dst_project.flights f
ORDER BY flight_time DESC
   LIMIT 1

/*
Вопрос 4. Сколько составляет средняя дальность полета среди всех самолетов в минутах? Секунды округляются в меньшую сторону (отбрасываются до минут).
*/

SELECT AVG(f.scheduled_departure - f.scheduled_arrival)
  FROM dst_project.flights f 

/*
Задание 4.5
Вопрос 1. Мест какого класса у SU9 больше всего?
*/

  SELECT DISTINCT s.fare_conditions, count(s.fare_conditions) AS fare_tally
    FROM dst_project.seats s
   WHERE s.aircraft_code = 'SU9'
GROUP BY s.fare_conditions
ORDER BY fare_tally desc
   LIMIT 1

/*
Вопрос 2. Какую самую минимальную стоимость составило бронирование за всю историю?
*/

  SELECT b.total_amount
    FROM dst_project.bookings b
ORDER BY b.total_amount 
   LIMIT 1

/*
Вопрос 3. Какой номер места был у пассажира с id = 4313 788533?
*/

SELECT b.seat_no
  FROM dst_project.boarding_passes b
  JOIN dst_project.tickets t ON b.ticket_no = t.ticket_no
 WHERE passenger_id = '4313 788533'

/*
Задание 5.1
Вопрос 1. Анапа — курортный город на юге России. Сколько рейсов прибыло в Анапу за 2017 год?
*/
SELECT COUNT(f.flight_id)
  FROM dst_project.flights f
  JOIN dst_project.airports a ON f.arrival_airport = a.airport_code
 WHERE a.city = 'Anapa' 
   AND EXTRACT (YEAR
               FROM f.actual_arrival) = '2017'

/*
Вопрос 2. Сколько рейсов из Анапы вылетело зимой 2017 года?
*/

SELECT COUNT(f.flight_id)
FROM dst_project.flights f
JOIN dst_project.airports a 
  ON f.departure_airport = a.airport_code
WHERE a.city = 'Anapa' 
 AND EXTRACT (YEAR
               FROM f.actual_arrival) = '2017'
 AND (EXTRACT (MONTH
                FROM f.actual_arrival) NOT BETWEEN '03' AND '11')


/*
Вопрос 3. Посчитайте количество отмененных рейсов из Анапы за все время.
*/

SELECT COUNT(f.flight_id)
FROM dst_project.flights f
JOIN dst_project.airports a ON f.departure_airport = a.airport_code
WHERE a.city = 'Anapa' 
  AND f.status = 'Cancelled' 

/*
Вопрос 4. Сколько рейсов из Анапы не летают в Москву?
*/

SELECT COUNT(f.flight_id)
  FROM dst_project.flights f
  JOIN dst_project.airports a ON f.arrival_airport = a.airport_code
 WHERE f.departure_airport = 'AAQ'
   AND city != 'Moscow' 

/*
Вопрос 5. Какая модель самолета летящего на рейсах из Анапы имеет больше всего мест?
*/

  SELECT a.model, COUNT(DISTINCT s.seat_no) seats_tally
    FROM dst_project.seats s
    JOIN dst_project.flights f ON s.aircraft_code = f.aircraft_code
    JOIN dst_project.aircrafts a ON s.aircraft_code = a.aircraft_code
   WHERE f.departure_airport = 'AAQ'
GROUP BY a.model